---
title: "Thermal niche model reported in Gutaker et al. 2020"
author:
  - R. Kyle Bocinsky
  - Jade d'Alpoim Guedes
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
   cores: 2
   clean: FALSE
   google_maps_elevation_api_key: !r Sys.getenv('google_maps_elevation_api_key')
output: 
    bookdown::html_document2:
      code_folding: hide
      df_print: paged
      fig_caption: yes
      toc: true
      toc_float: true
      toc_depth: 3
editor_options: 
  chunk_output_type: console
---

This RMarkdown document creates the thermal niche model reported in 

> Gutaker et al. *In review.*

```{r, setup, echo = FALSE, cache = FALSE}
# params <- list(cores = 2,
#                clean = FALSE)

# Set the knitting behavior
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      collapse = TRUE, 
                      # cache = FALSE,
                      cache = !params$clean,
                      cache.lazy = FALSE,
                      results = 'hold',
                      out.width = "100%",
                      fig.height = 5,  
                      comment = "#>",
                      fig.path = "./figures/"
)

library(gutaker2020)
library(sf)
library(magrittr)
library(fields)

# Set the behavior for printing scientific notation
# options(digits = 3, scipen = -2)
options(scipen = 999,
        knitr.table.format = "html")

# Force Raster to load large rasters into memory
raster::rasterOptions(chunksize = 2e+08,
                      maxmemory = 2e+09)

# Create the plan for (possibly parallel) execution
future::plan(future::multisession, 
             workers = min(future::availableCores(), 
                           params$cores),
             gc = TRUE)

# Create output directories
dir.create("./data/raw_data",
           recursive = TRUE,
           showWarnings = FALSE)
dir.create("./data/derived_data",
           recursive = TRUE,
           showWarnings = FALSE)
dir.create("./figures",
           recursive = TRUE,
           showWarnings = FALSE)

```

## Set parameters {-}
In this section we define the study area by a bounding box, the calendar years used to define climatology (here, 1961--1990), and a plotting theme for **ggplot**.

```{r set-params}
# Set a series of colors for the crops
crop_colors <- RColorBrewer::brewer.pal(6,"Dark2")

# A function to set an objects class
set_class <- function(x, classes){
  class(x) <- classes
  return(x)
}

#Define the study region
ASIA_poly <-
  raster::extent(55,150,-11,60) %>%
  FedData::polygon_from_extent("+proj=longlat") %>%
  sf::st_as_sf()

# Set the calibration period for paleoclimate reconstructions
calibration.years <- 1961:1990

# A ggplot2 theme for Nature Publishing Group
nature_theme <- ggplot2::theme(panel.grid.major = ggplot2::element_line(size = 0.5, 
                                                                        color = "grey"),
                               axis.line = ggplot2::element_line(size = 0.7, 
                                                                 color = "black"),
                               legend.position = c(0.85, 0.7),
                               text = ggplot2::element_text(size = 14))
```

## Load ETOPO5 grids {-}
Indicator kriging takes place on the ETOPO5 digital elevation model. Here, we load the ETOPO5 data from the **geomapdata** package, then mask out the oceans adn large lakes, as well as islands outside of mainland Asia.
```{r etopo5}
message("Preparing the ETOPO5 grid-aligned dataset")

time_check <-  Sys.time()

if(!params$clean & file.exists("./data/derived_data/ASIA_rast_etopo5.tif")){
  
  ASIA_rast_etopo5 <- raster::raster("./data/derived_data/ASIA_rast_etopo5.tif")
  
}else{
  
  # Get the Natural Earth country lakes data
  dir.create("./data/derived_data/NaturalEarth/", 
             showWarnings = FALSE, 
             recursive = TRUE)
  
  FedData::download_data(
    url = "http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/physical/ne_10m_lakes.zip",
    destdir = "./data/derived_data/NaturalEarth/"
  )
  
  unzip(
    "./data/derived_data/NaturalEarth/ne_10m_lakes.zip", 
    exdir = "./data/derived_data/NaturalEarth/ne_10m_lakes/"
  )
  
  ne_10m_lakes <- "./data/derived_data/NaturalEarth/ne_10m_lakes/ne_10m_lakes.shp" %>%
    sf::st_read() %>%
    sf::st_transform(sf::st_crs(ASIA_poly)) %>%
    sf::st_intersection(ASIA_poly)
  
  # Get the Natural Earth country boundaries data
  dir.create(
    "./data/derived_data/NaturalEarth/ne_10m_admin_0_countries_lakes/",
    showWarnings = FALSE, 
    recursive = TRUE
  )
  FedData::download_data(
    url = "http://www.naturalearthdata.com/http//www.naturalearthdata.com/download/10m/cultural/ne_10m_admin_0_countries_lakes.zip",
    destdir = "./data/derived_data/NaturalEarth/"
  )
  
  unzip(
    "./data/derived_data/NaturalEarth/ne_10m_admin_0_countries_lakes.zip", 
    exdir = "./data/derived_data/NaturalEarth/ne_10m_admin_0_countries_lakes/"
  )
  
  ne_10m_admin_0_countries_lakes <- "./data/derived_data/NaturalEarth/ne_10m_admin_0_countries_lakes/ne_10m_admin_0_countries_lakes.shp" %>%
    sf::st_read() %>%
    sf::st_transform(sf::st_crs(ASIA_poly)) %>%
    sf::st_intersection(ASIA_poly) %>%
    dplyr::filter(!(NAME %in% c("Scarborough Reef",
                                "Maldives",
                                "Spratly Is.",
                                "Oman",
                                "United Arab Emirates",
                                "Saudi Arabia")))
  
  library(geomapdata)
  data("ETOPO5")
  
  ASIA_rast_etopo5 <- ETOPO5 %>%
    t() %>%
    raster::raster(xmn = 0,
                   xmx = 360,
                   ymn = -90,
                   ymx = 90,
                   crs = sp::CRS("+proj=longlat +ellps=clrk66 +no_defs")) %>%
    raster::crop(ASIA_poly %>%
                   sf::st_transform("+proj=longlat +ellps=clrk66 +no_defs") %>%
                   as("Spatial")) %>%
    raster::mask(ne_10m_admin_0_countries_lakes %>%
                   sf::st_transform("+proj=longlat +ellps=clrk66 +no_defs") %>%
                   as("Spatial")) %>%
    raster::mask(ne_10m_lakes %>%
                   sf::st_transform("+proj=longlat +ellps=clrk66 +no_defs") %>%
                   as("Spatial"),
                 inverse = TRUE) %T>%
    raster::writeRaster(filename = "./data/derived_data/ASIA_rast_etopo5.tif",
                        datatype="INT2S",
                        options=c("COMPRESS=DEFLATE", "ZLEVEL=9", "INTERLEAVE=BAND", "PHOTOMETRIC=MINISWHITE"),
                        overwrite=T,
                        setStatistics=FALSE)
  rm(ETOPO5)
}

countries <- "./data/derived_data/NaturalEarth/ne_10m_admin_0_countries_lakes/ne_10m_admin_0_countries_lakes.shp" %>%
  sf::st_read()  %>%
  sf::st_transform(sf::st_crs(ASIA_poly)) %>%
  sf::st_intersection(ASIA_poly) %>%
  dplyr::filter(!(NAME %in% c("Scarborough Reef",
                              "Maldives",
                              "Spratly Is.",
                              "Oman",
                              "United Arab Emirates",
                              "Saudi Arabia"))) %>%
  dplyr::select(NAME, geometry)

message("ETOPO5 grid-aligned dataset preparation complete: ", capture.output(Sys.time() - time_check))

```

## Prepare the GHCN data {-}
Here, we download daily weather records from the Global Historical Climatology Network, 
```{r ghcn}
## Downloads and cleans daily climate records from the Global Historical Climate Database.
message("Preparing the daily climate records from the Global Historical Climate Database")
time_check <-  Sys.time()
GHCN.data.final <- prepare_ghcn(region = ASIA_poly %>%
                                  as("Spatial"),
                                label = "ASIA_poly",
                                calibration.years = calibration.years,
                                google_maps_elevation_api_key = params$google_maps_elevation_api_key,
                                raw_dir = "./data/raw_data/ghcn/",
                                derived_dir = "./data/derived_data/ghcn/",
                                force.redo = params$clean)
message("GHCN preparation complete: ", capture.output(Sys.time() - time_check))
## An example of plotting the GHCN data
# climate_plotter(data = GHCN.data.final, station = "CHM00051334", element = "TMIN")

```

## Prepare the Marcott data {-}
```{r marcott}
# Run the script that transforms the Marcott et al. 2013 data into standard scores.
message("Preparing the Marcott et al. 2013 data")
time_check <-  Sys.time()
marcott2013 <- prepare_marcott(calibration.years = calibration.years)
message("Marcott et al. 2013 data preparation complete: ", capture.output(Sys.time() - time_check))

```

## Modulating climatology by SD {-}
```{r sd-modulation}
#### Calculating growing degree days ####
message("Modulating local climatology by Marcott et al. 2013 data")
time_check <-  Sys.time()
# How often to sample GDD, in z-space, for model tuning
# Here, we sample from -20 to 20 SD, at 1 SD interval
sample.points <- -20:20

# Read in data on different crop GDD needs
crop_GDD <- readr::read_csv("../inst/crops.csv",
                            col_types = readr::cols(
                              cultivar_long = readr::col_character(),
                              cultivar = readr::col_character(),
                              crop_long = readr::col_character(),
                              crop = readr::col_character(),
                              t_base = readr::col_double(),
                              min_gdd = readr::col_integer()
                            ))

crop_GDD %>%
  readr::write_csv("./data/derived_data/Table_S1_crops.csv")

# Transform GHCN data to GDDs of each base, and modulate to Marcott
GDDs <- sort(unique(crop_GDD$t_base))

GHCN.GDD.incremented.sd <-
  furrr::future_map(GDDs,
                    # purrr::map(GDDs,
                    .options = furrr::future_options(
                      packages = c("magrittr",
                                   "gutaker2019"),
                      globals = c("sample.points",
                                  "GHCN.data.final")),
                    .f = function(base){
                      purrr::map_dfr(sample.points,
                                     function(change){
                                       
                                       GHCN.GDDs <-
                                         purrr::map_dbl(GHCN.data.final$climatology,
                                                        function(station){
                                                          return(sdModulator(data.df = station,
                                                                             temp.change.sd = change,
                                                                             t.base = base,
                                                                             t.cap = 30))
                                                        })
                                       
                                       
                                       names(GHCN.GDDs) <- names(GHCN.data.final$climatology)
                                       
                                       return(tibble::tibble(SD_change = change,
                                                             ID = names(GHCN.GDDs),
                                                             GDD = GHCN.GDDs))
                                       
                                     }) %>%
                        dplyr::left_join(GHCN.data.final$spatial %>%
                                           dplyr::as_data_frame() %>%
                                           magrittr::set_names(c("ID",
                                                                 "NAME",
                                                                 "elevation",
                                                                 "x",
                                                                 "y")),
                                         by = "ID")
                      
                    })

names(GHCN.GDD.incremented.sd) <- GDDs

# stop the cluster (will free memory)
# stopCluster(cl)
message("Modulation of local climatology by Marcott et al. 2013 data complete: ", capture.output(Sys.time() - time_check))

```

## Generate the crop niche models {-}
```{r generate-niche-models}
message("Calculating indicator Krige models")
time_check <-  Sys.time()
# Create a spatialPointsDataFrame of the etopo5 data, and convert to WGS84 ellipsoid
ASIA_rast_etopo5.sp <-
  ASIA_rast_etopo5 %>%
  magrittr::set_names("elevation") %>%
  raster::rasterToPoints(spatial = T) %>%
  sp::spTransform(sp::CRS(raster::projection(GHCN.data.final$spatial)))

# A function that generates the kriging model, then predicts
krige_and_predict <- function(dt){
  model <- fields::mKrig(x = dt[,c("x","y")],
                         y = dt$GDD_thresh,
                         Z = dt$elevation,
                         Covariance = "Exponential",
                         Distance = "rdist.earth")
  
  prediction <- ASIA_rast_etopo5.sp %>%
    tibble::as_tibble() %>%
    dplyr::mutate(chunk = rep(1:ceiling(nrow(.)/chunk_size),length.out = nrow(.)) %>%
                    sort()
    ) %>%
    dplyr::group_by(chunk) %>%
    dplyr::do(prediction = fields::predict.mKrig(model,
                                                 xnew = .[,c("x","y")],
                                                 Z = .$elevation) %>%
                as.vector()) %$%
    prediction %>%
    unlist()
  
  return(list(model = model, prediction = prediction))
  
}

# Calculate gdd kriging models for each crop
gdd_model_files <- paste0("./data/derived_data/models/",crop_GDD$cultivar,"_models.rds")

if(params$clean){
  unlink("./data/derived_data/models/", recursive = TRUE, force = TRUE)
  dir.create("./data/derived_data/models/", recursive = TRUE, showWarnings = F)
  crop_GDD_run <- crop_GDD
}else{
  dir.create("./data/derived_data/models/", recursive = TRUE, showWarnings = F)
  crop_GDD_run <- crop_GDD[!file.exists(gdd_model_files),]
}

if(nrow(crop_GDD_run) == 0){
  message("All indicator Krige models have already been calculated. Continuing.")
}else message("Calculating indicator Krige models for ",
              nrow(crop_GDD_run),
              " cultivars:\n",
              paste0(capture.output(crop_GDD_run), collapse = "\n"))

# A function to reduce the size of a loess model by half
skinny.loess <- function(x){
  x[c("fitted",
      "residuals",
      "enp",
      "one.delta",
      "two.delta",
      "trace.hat",
      "call",
      "terms",
      "xnames")] <- NULL
  return(x)
}

# A function of correct the indication predictions and estimate a smooth
# monotonic function
# This first uses isotonic regression, then loess smoothing with a degree of 1
smooth.preds <- function(y){
  y[y<0] <- 0
  y[y>1] <- 1
  y <- loess(isoreg(y~sample.points)$yf~sample.points, span=0.1, degree=1) %>%
    skinny.loess()
  return(y)
}

if(nrow(crop_GDD_run) > 0){
  options(dplyr.show_progress = FALSE)
  chunk_size <- 10000
  
  gdd.models <-
    furrr::future_map(1:nrow(crop_GDD_run),
                      .options = furrr::future_options(
                        packages = c("fields",
                                     "dplyr",
                                     "magrittr",
                                     "readr",
                                     "gutaker2019")),
                      .f = function(crop){
                        
                        # Threshold for indicator kriging
                        GHCN.GDD.incremented.sd[[as.character(crop_GDD_run[crop,"t_base"])]] %>%
                          dplyr::mutate(GDD_thresh = {GDD >= as.numeric(crop_GDD_run[crop,"min_gdd"])}) %>%
                          dplyr::group_by(SD_change) %>%
                          dplyr::do(out_preds = krige_and_predict(.)) %$%
                          out_preds %>%
                          sapply("[[","prediction") %>%
                          apply(1,smooth.preds) %>%
                          tibble::tibble(model = .) %>%
                          maptools::spCbind(ASIA_rast_etopo5.sp,.) %>%
                          readr::write_rds(paste0("./data/derived_data/models/",
                                                  crop_GDD_run[crop,"cultivar"],
                                                  "_models.rds"), 
                                           compress = "xz")
                        
                        return(paste0("./data/derived_data/models/",
                                      crop_GDD_run[crop,"cultivar"],
                                      "_models.rds"))
                        
                      })
  
}

rm(ASIA_rast_etopo5,
   ASIA_rast_etopo5.sp,
   GHCN.data.final,
   GHCN.GDD.incremented.sd)

message("Calculation indicator Krige models complete: ", capture.output(Sys.time() - time_check))

```

## Predict crop niches through time {-}
```{r predict-niches}
## Predicting crop niche from smoothed Krige models
# Calculate niches for each crop using the Marcott et al. 2013.
# create the cluster for parallel computation
message("Generating niche reconstructions")
time_check <-  Sys.time()
if(params$clean){
  unlink("./data/derived_data/recons/", recursive = TRUE, force = TRUE)
}
dir.create("./data/derived_data/recons/", recursive = TRUE, showWarnings = F)

# Create the plan for (possibly parallel) execution
future::plan(future::multisession, 
             workers = max(
               floor(
                 min(
                   future::availableCores(), 
                   params$cores)/2), 
               1),
             gc = TRUE)

junk <- furrr::future_map(crop_GDD$cultivar,    
                          .options = furrr::future_options(
                            packages = c("fields",
                                         "dplyr",
                                         "magrittr",
                                         "sp",
                                         "readr",
                                         "gutaker2019")),
                          function(crop){
                            
                            if(file.exists(paste0("./data/derived_data/recons/",
                                                  crop,
                                                  "_recons.rds")))
                              return()
                            
                            if(!file.exists(paste0("./data/derived_data/models/",
                                                   crop,
                                                   "_models.rds"))) 
                              stop("Models for ",
                                   crop,
                                   " are missing! Aborting.")
                            
                            Zs <- c("Z_Lower","Z","Z_Upper")
                            
                            crop.models <- readr::read_rds(paste0("./data/derived_data/models/",
                                                                  crop,
                                                                  "_models.rds"))
                            
                            out <- purrr::map(Zs, 
                                              function(z){
                                                suppressWarnings(crop.models@data %$%
                                                                   model %>%
                                                                   purrr::map(
                                                                     function(x){
                                                                       x %>%
                                                                         predict(newdata = marcott2013[[z]]) %>%
                                                                         magrittr::multiply_by(100) %>%
                                                                         round() %>%
                                                                         as.integer()
                                                                     }) %>%
                                                                   do.call(rbind, .) %>%
                                                                   tibble::as_tibble() %>%
                                                                   magrittr::set_colnames(marcott2013$YearBP) %>%
                                                                   new("SpatialPointsDataFrame",
                                                                       data = .,
                                                                       coords.nrs = crop.models@coords.nrs,
                                                                       coords = crop.models@coords,
                                                                       bbox = crop.models@bbox,
                                                                       proj4string = crop.models@proj4string) %>%
                                                                   as("SpatialPixelsDataFrame") %>%
                                                                   raster::brick() %>%
                                                                   raster::setZ(marcott2013$YearBP,
                                                                                name="Years BP"))
                                              }) %>%
                              magrittr::set_names(Zs) %>%
                              readr::write_rds(paste0("./data/derived_data/recons/",
                                                      crop,
                                                      "_recons.rds"),
                                               compress = "xz",
                                               compression = 9)
                            
                            return()
                          })

message("Generation of niche reconstructions complete: ", capture.output(Sys.time() - time_check))

```

## Combine similar crop niches {-}
```{r combine-niches}
## Combining crop niches from similar crops by taking an arithmatic mean
message("Combining like crop niches")
time_check <-  Sys.time()

purrr::walk(crop_GDD %>%
              split(as.factor(crop_GDD$crop)),
            function(x){
              if(file.exists(paste0("./data/derived_data/recons/all_",x$crop[[1]],".rds"))) return()
              n_crops <- length(x$crop)
              if(n_crops == 1){
                file.copy(paste0("./data/derived_data/recons/",
                                 x$cultivar[[1]],
                                 "_recons.rds"),
                          paste0("./data/derived_data/recons/all_",
                                 x$crop[[1]],
                                 ".rds"))
                return()
              }
              
              test <- purrr::map(x$cultivar, function(cultivar){
                paste0("./data/derived_data/recons/",cultivar,"_recons.rds") %>%
                  readr::read_rds()
              }) %>%
                purrr::transpose() %>%
                purrr::map(function(x){
                  x %>%
                    Reduce(f = "+", x = .) %>%
                    magrittr::divide_by(n_crops) %>%
                    round() %>%
                    as.integer()
                }) %>%
                readr::write_rds(paste0("./data/derived_data/recons/all_",
                                        x$crop[[1]],
                                        ".rds"),
                                 compress = "xz",
                                 compression = 9)
            })

message("Combining like crop niches complete: ", capture.output(Sys.time() - time_check))

```



```{r plot-niches-through-time, cache = FALSE}
## Plotting cultivar niche
# create the cluster for parallel computation
message("Plotting cultivar niche reconstructions")
time_check <-  Sys.time()

dir.create("./figures/cultivar_niches/",
           recursive = TRUE,
           showWarnings = FALSE)

gdd.recons <- 
  purrr::map_chr(1:nrow(crop_GDD),
                 function(n){
                   
                   cultivar <- crop_GDD[n,]$cultivar
                   
                   title <- stringr::str_c(crop_GDD[n,]$cultivar_long,
                                           " \u2014 T_base: ",
                                           crop_GDD[n,]$t_base,
                                           "°C, Required GDD: ",
                                           crop_GDD[n,]$min_gdd)
                   
                   if(file.exists(paste0("./figures/cultivar_niches/",cultivar,".pdf")) & file.exists(paste0("./figures/cultivar_niches/",cultivar,".mp4")))
                     return(paste0("./figures/cultivar_niches/",cultivar,".pdf"))
                   
                   rasts <- readr::read_rds(paste0("./data/derived_data/recons/",cultivar,"_recons.rds")) %>%
                     purrr::map(function(x){
                       x %>%
                         magrittr::extract2(which(.@z$`Years BP` > 1000)) %>%
                         # raster:::readAll() %>%
                         magrittr::extract2(raster::nlayers(.):1) 
                     })
                   
                   
                   years <- rasts[[1]] %>%
                     names() %>%
                     gsub(pattern = "X",
                          replacement = "",
                          x = .) %>%
                     as.numeric()
                   
                   breaks <- seq(0, 100, 10)
                   
                   pal <- (RColorBrewer::brewer.pal(10, "Spectral") %>%
                             rev() %>%
                             colorRampPalette(.))(length(breaks) - 1)
                   
                   if(!file.exists(paste0("./figures/cultivar_niches/",cultivar,".pdf")))
                     gutaker2019:::space_time_plot(
                       the_brick = rasts$Z,
                       the_brick_lower = rasts$Z_Lower,
                       the_brick_upper = rasts$Z_Upper,
                       out_file = paste0("./figures/cultivar_niches/",cultivar,".pdf"),
                       title = title,
                       time = years,
                       timelim = c(max(years),min(years)),
                       timeaxis =  seq(from = max(years)-500,
                                       to = min(years),
                                       by = -500),
                       timelab = "Years BP",
                       zbreaks = breaks,
                       zlab = "Probability of being in niche",
                       zaxis = seq(0,100,10),
                       zcolors = pal
                     )
                   
                   if(!file.exists(paste0("./figures/cultivar_niches/",cultivar,".mp4")))
                     gutaker2019:::space_time_video(                       the_brick = rasts$Z,
                                                                           the_brick_lower = rasts$Z_Lower,
                                                                           the_brick_upper = rasts$Z_Upper,
                                                                           out_file = paste0("./figures/cultivar_niches/",cultivar,".mp4"),
                                                                           title = title,
                                                                           time = years,
                                                                           timelim = c(max(years),min(years)),
                                                                           timeaxis =  seq(from = max(years)-500,
                                                                                           to = min(years),
                                                                                           by = -500),
                                                                           timelab = "Years BP",
                                                                           zbreaks = breaks,
                                                                           zlab = "Probability of being in niche",
                                                                           zaxis = seq(0,100,10),
                                                                           zcolors = pal
                     )
                   
                   return(paste0("./figures/cultivar_niches/",cultivar,".pdf"))
                   
                 })

message("Plotting of cultivar niche reconstructions complete: ", capture.output(Sys.time() - time_check))

```

## Generate niche videos {-}
```{r niche-videos}

## Plotting crop niche with associated sites
# create the cluster for parallel computation
message("Plotting crop niche reconstructions")
time_check <-  Sys.time()

# Combine the sites with the density data
site_densities <- niche_densities %>%
  dplyr::filter(!purrr::map_lgl(Niche, is.null)) %>%
  dplyr::mutate(Density_Lower = marcott2013$YearBP[purrr::map(Density, "CI") %>%
                                                     purrr::map_dbl("lower")],
                Density_Upper = marcott2013$YearBP[purrr::map(Density, "CI") %>%
                                                     purrr::map_dbl("upper")]) %>%
  dplyr::select(-Density) %>%
  dplyr::filter(!is.na(Density_Lower)) %>%
  dplyr::left_join(sites %>%
                     sf::st_set_geometry(NULL), 
                   by = c("Site", "Period", "Crop")) %>%
  dplyr::mutate(Niche = purrr::map(Niche, function(x){
    x$Niche <-
      tibble::tibble(`Year BP` = marcott2013$YearBP, 
                     Niche = x$Niche)
    return(x)
  }))

crops <- crop_GDD %>%
  dplyr::filter(crop %in% site_densities$Crop) %>%
  dplyr::select(crop_long, crop) %>%
  dplyr::distinct()

message("Generating niche videos.")
dir.create("./figures/crop_niches",
           recursive = TRUE,
           showWarnings = FALSE)

for(n in 1:nrow(crops)){
  
  crop <- crops[n,]$crop
  
  title <- stringr::str_c(crops[n,]$crop_long)
  
  if(file.exists(paste0("./figures/crop_niches/all_",crop,".pdf")) & file.exists(paste0("./figures/crop_niches/all_",crop,".mp4")))
    next
  
  rasts <- readr::read_rds(paste0("./data/derived_data/recons/all_",crop,".rds")) %>%
    purrr::map(function(x){
      x %>%
        magrittr::extract2(which((x %>%
                                    names() %>%
                                    gsub(pattern = "X",
                                         replacement = "",
                                         x = .) %>%
                                    as.numeric()) > 1000)) %>%
        # raster:::readAll() %>%
        magrittr::extract2(raster::nlayers(.):1)
    })
  
  years <- rasts[[1]] %>%
    names() %>%
    gsub(pattern = "X",
         replacement = "",
         x = .) %>%
    as.numeric()
  
  breaks <- seq(0, 100, 10)
  
  pal <- (RColorBrewer::brewer.pal(10, "Spectral") %>%
            rev() %>%
            colorRampPalette(.))(length(breaks) - 1)
  
  if(!file.exists(paste0("./figures/crop_niches/all_",crop,".pdf")))
    gutaker2019:::space_time_plot(the_brick = rasts$Z,
                                  the_brick_lower = rasts$Z_Lower,
                                  the_brick_upper = rasts$Z_Upper,
                                  out_file = paste0("./figures/crop_niches/all_",crop,".pdf"),
                                  title = title,
                                  time = years,
                                  timelim = c(max(years),min(years)),
                                  timeaxis =  seq(from = max(years)-500,
                                                  to = min(years),
                                                  by = -500),
                                  timelab = "Years BP",
                                  zbreaks = breaks,
                                  zlab = "Probability of being in niche",
                                  zaxis = seq(0,100,10),
                                  zcolors = pal
    )
  
  
  if(!file.exists(paste0("./figures/crop_niches/all_",crop,".mp4"))){
    # A function to extract site locations for a given year and crop, and plot them
    sites_plot <- function(years = NULL,
                           crops = NULL,
                           scale = scales::area_pal(c(0,1))){
      x_plot <- site_densities
      year_idx <- which(marcott2013$YearBP == years)
      
      if(!is.null(crops)){
        x_plot %<>%
          dplyr::filter(Crop %in% crops)
      }
      
      cexs <- purrr::map(x_plot$Niche,c("Niche","Niche")) %>%
        purrr::map(year_idx) %>%
        unlist() %>%
        scale()
      
      if(cexs %>%
         is.na() %>%
         all()) return() #Don't plot if no sites during this period
      
      x_plot %<>%
        dplyr::filter(!is.na(cexs))
      
      cexs <- cexs[!is.na(cexs)]
      
      x_plot %$%
        plot(geometry,
             cex = cexs,
             pch = 1,
             lwd = 3,
             col = "white",
             add = T)
      x_plot %$%
        plot(geometry,
             cex = cexs,
             pch = 1,
             lwd = 1.5,
             col = "black",
             add = T)
    }
    
    sites_legend <- function(){
      legend("bottomright",
             title = "Site % probability \nof being in niche",
             legend = seq(0,100,20),
             pch = 1,
             pt.lwd = 1.5,
             col = "black",
             pt.cex = scales::area_pal(c(0.5,3))(seq(0,1,0.2)),
             bty = "n",
             y.intersp = 1.5,
             cex = 0.8,
             text.font = 2
      )
    }
    
    gutaker2019:::space_time_video(the_brick = rasts$Z,
                                   the_brick_lower = rasts$Z_Lower,
                                   the_brick_upper = rasts$Z_Upper,
                                   out_file = paste0("./figures/crop_niches/all_",crop,".mp4"),
                                   title = title,
                                   time = years,
                                   timelim = c(max(years),min(years)),
                                   timeaxis =  seq(from = max(years)-500,
                                                   to = min(years),
                                                   by = -500),
                                   timelab = "Years BP",
                                   zbreaks = breaks,
                                   zlab = "Probability of being in niche",
                                   zaxis = seq(0,100,10),
                                   zcolors = pal,
                                   extra_plot_fun = purrr::partial(sites_plot,
                                                                   crops = crop,
                                                                   scale = scales::area_pal(c(0.5,3))),
                                   extra_legend_fun = sites_legend
    )
    
  }
}





# Create a static plot for paper publication
# A function to extract data from a crop raster brick
tidyCrop <- function(x, years){
  x %>%
    paste0("./data/derived_data/recons/all_",.,".rds") %>%
    readr::read_rds() %$%
    Z %>%
    magrittr::extract2(stringr::str_c("X",years)) %>%
    as("SpatialPixelsDataFrame") %>%
    tibble::as_tibble() %>%
    tidyr::gather(Year, Niche, -x:-y) %>%
    dplyr::rename(Longitude = x,
                  Latitude = y) %>%
    dplyr::mutate(Year = stringr::str_remove(Year, "X") %>%
                    factor(levels = years) %>%
                    forcats::fct_relabel(function(x){stringr::str_c(x," cal. BP")}),
                  Crop = x)
}

breaks <- seq(0, 100, 10)

pal <- (RColorBrewer::brewer.pal(10, "Spectral") %>%
          rev() %>%
          colorRampPalette(.))(length(breaks) - 1)

# A function to create a plot of years and crops
facet_niche <- function(crops, years){
  these_sites <- years %>%
    purrr::map(function(year){
      site_densities %>%
        dplyr::mutate(Year = year) %>%
        dplyr::filter(Density_Lower <= Year & Density_Upper >= Year,
                      Crop %in% crops) %>%
        dplyr::mutate(Longitude = sf::st_coordinates(geometry)[,1],
                      Latitude = sf::st_coordinates(geometry)[,2]) %>%
        dplyr::select(Site, Longitude, Latitude, Crop, Year)
    }) %>%
    do.call(rbind, .) %>%
    dplyr::mutate(Year = factor(Year, levels = years) %>%
                    forcats::fct_relabel(function(x){stringr::str_c(x," cal. BP")}),
                  Crop = dplyr::recode_factor(Crop,
                                              rice = "Rice"))
  
  these_rasters <- crops %>%
    purrr::map(tidyCrop, years = years) %>%
    dplyr::bind_rows() %>%
    dplyr::mutate(Crop = dplyr::recode_factor(Crop,
                                              rice = "Rice"),
                  Niche = Niche  %>%
                    cut(breaks = breaks,
                        include.lowest = TRUE)) 
  
  p <- these_rasters %>%
    ggplot2::ggplot() +
    ggplot2::geom_raster(mapping = ggplot2::aes(x = Longitude,
                                                y = Latitude,
                                                fill = Niche),
                         show.legend = TRUE) +
    ggplot2::geom_point(data = these_sites,
                        mapping = ggplot2::aes(x = Longitude,
                                               y = Latitude),
                        size = 1) +
    ggplot2::coord_quickmap() +
    ggplot2::facet_grid(Crop ~ Year,
                        switch = "y")
  
  return(p)
}

p <- facet_niche(crops = c("rice"),
                 years = c(4410, 3550))

cairo_pdf("./figures/Figure_2_facet_niche.pdf", width = 7.2, height = 10.3)
print({
  p +
    ggplot2::scale_fill_manual(values = pal,
                               labels = c("0–10%",
                                          "10–20%",
                                          "20–30%",
                                          "30–40%",
                                          "40–50%",
                                          "50–60%",
                                          "60–70%",
                                          "70–80%",
                                          "80–90%",
                                          "90–100%"),
                               drop = FALSE,
                               name = "Probability of being in the thermal niche",
                               guide = ggplot2::guide_legend(
                                 direction = "horizontal",
                                 keyheight = ggplot2::unit(0.1, units = "in"),
                                 keywidth = ggplot2::unit(6/10, units = "in"),
                                 title.position = 'top',
                                 title.hjust = 0.5,
                                 label.hjust = 0,
                                 nrow = 1,
                                 byrow = T,
                                 label.position = "bottom"
                               )) +
    ggplot2::scale_y_continuous(position = "right") +
    ggplot2::theme_minimal(base_size = 7) +
    ggplot2::theme(plot.margin = ggplot2::margin(0,0,0,0, "in"),
                   strip.text.x = ggplot2::element_text(size = 8),
                   strip.text.y = ggplot2::element_text(size = 8),
                   legend.position = "bottom",
                   legend.margin = ggplot2::margin(0,0,0.1,0, "in"),
                   legend.title = ggplot2::element_text(face = "bold"))
  
})
dev.off()

message("Plotting of crop niche reconstructions complete: ", capture.output(Sys.time() - time_check))

```

## Are GDD differences between Japan and Thailand stable across the reconstruction? {-}
```{r niche-compare}
japan_thai <- countries %>%
  dplyr::filter(NAME %in% c("Japan","Thailand"))

# # Get the pixel counts
# crop <- "tropical"
# y.vx <- velox::velox(readr::read_rds(paste0("./data/derived_data/recons/all_",crop,".rds"))[[1]])
# y.vx$extract(japan_thai,
#              fun = function(i){sum(!is.na(i))})[,1]

japan_thai_data <-
  c("Tropical Japonica" = "tropical",
    "Temperate Japonica" = "temperate",
    "Indica" = "indica") %>%
  purrr::map(
    function(crop){
      readr::read_rds(paste0("./data/derived_data/recons/all_",crop,".rds")) %>%
        purrr::map(function(y){
          y.vx <- velox::velox(y)
          y.vx$extract(japan_thai,
                       fun = function(i){mean(i, na.rm = TRUE)}) %>%
            t() %>%
            tibble::as_tibble() %>%
            magrittr::set_names(japan_thai$NAME) %>%
            dplyr::mutate(`Years BP` = 
                            names(y) %>% 
                            stringr::str_remove("X") %>% 
                            as.integer()) %>%
            dplyr::select(`Years BP`,
                          dplyr::everything())
        }) 
    }
  ) %>%
  purrr::map(dplyr::bind_rows,
             .id = "Series") %>%
  dplyr::bind_rows(.id = "Crop") %>%
  tidyr::gather(Country, `Probability of being in niche`,-Crop:-`Years BP`) %>%
  tidyr::spread(Series, `Probability of being in niche`)

japan_thai_data %>%
  ggplot2::ggplot(ggplot2::aes(x = `Years BP`,
                               color = Country)) +
  ggplot2::geom_ribbon(ggplot2::aes(ymin = Z_Lower,
                                    ymax = Z_Upper,
                                    fill = Country),
                       color = NA,
                       alpha = 0.3) +
  ggplot2::geom_line(ggplot2::aes(y = Z)) +
  ggplot2::scale_x_reverse(limits = c(5510,1010),
                           breaks = seq(5510,1010,-500),
                           expand = c(0,0)) +
  ggplot2::scale_y_continuous(name = "Probability of being in niche",
                              limits = c(0,100),
                              expand = c(0,0)) +
  
  ggplot2::facet_wrap(facets = "Crop",
                      ncol = 1) +
  ggplot2::theme_minimal() +
  ggplot2::theme(legend.position="bottom",
                 plot.margin = ggplot2::margin(t = 0, r = 10, b = 0, l = 0, unit = "pt"))

ggplot2::ggsave("./figures/japan_thailand_compare.pdf",
                width = 6.5,
                height = 6)


smooth.preds <- function(y){
  y[y<0] <- 0
  y[y>1] <- 1
  y <- loess(isoreg(y~sample.points)$yf~sample.points, span=0.1, degree=1) %>%
    skinny.loess()
  return(y)
}

test <- 
  GHCN.data.final$spatial %>%
  sf::st_as_sf() %>%
  sf::st_transform(sf::st_crs(japan_thai)) %>%
  sf::st_intersection(japan_thai) %>%
  dplyr::select(ID) %>%
  tibble::as_tibble() %>%
  sf::st_as_sf() %>%
  dplyr::left_join(
    GHCN.GDD.incremented.sd[[1]] %>%
      dplyr::group_by(ID) %>%
      dplyr::summarise(`GDD Model` = list(loess(isoreg(GDD~SD_change)$yf~sample.points, span=0.1, degree=1)))
  ) %>%
  dplyr::rowwise() %>%
  dplyr::mutate(`GDD` = list(
    marcott2013 %>%
      dplyr::select(`Years BP` = YearBP,
                    Z_Lower,
                    Z,
                    Z_Upper) %>%
      dplyr::mutate_at(.vars = vars(Z_Lower,
                                    Z,
                                    Z_Upper),
                       .funs = function(x){
                         predict(`GDD Model`,newdata = x)
                       })
  ))

test %>%
  sf::st_as_sf() %>%
  dplyr::select(GDD) %>%
  dplyr::ungroup() %>%
  sf::st_intersection(japan_thai) %>%
  dplyr::rename(Country = NAME) %>%
  sf::st_drop_geometry() %>%
  tidyr::unnest() %>%
  dplyr::group_by(Country,`Years BP`) %>%
  dplyr::summarise_all(mean, na.rm = TRUE) %>%
  ggplot2::ggplot(ggplot2::aes(x = `Years BP`,
                               color = Country)) +
  ggplot2::geom_ribbon(ggplot2::aes(ymin = Z_Lower,
                                    ymax = Z_Upper,
                                    fill = Country),
                       color = NA,
                       alpha = 0.3) +
  ggplot2::geom_line(ggplot2::aes(y = Z)) +
  ggplot2::scale_x_reverse(limits = c(5510,1010),
                           breaks = seq(5510,1010,-500),
                           expand = c(0,0)) +
  ggplot2::scale_y_continuous(name = "Growing Degree Days",
                              limits = c(0,8000),
                              expand = c(0,0)) +
  ggplot2::theme_minimal() +
  ggplot2::theme(legend.position="bottom",
                 plot.margin = ggplot2::margin(t = 10, r = 10, b = 0, l = 0, unit = "pt"))

ggplot2::ggsave("./figures/japan_thailand_GDD_compare.pdf",
                width = 6.5,
                height = 6.5/1.618)

```

# Copy Data Files
file.copy(from = "./data/derived_data/Data_file_S1_sites_dates.xlsx",
to = "./submission/Data_file_S1_sites_dates.xlsx",
overwrite = TRUE)

file.copy(from = "./figures/Data_file_S2_all_crossplot.html",
to = "./submission/Data_file_S2_all_crossplot.html",
overwrite = TRUE)

# Copy Movies
file.copy(from = "./figures/crop_niches/all_wheat.mp4",
to = "./submission/Movie_S1_wheat.mp4",
overwrite = TRUE)
file.copy(from = "./figures/crop_niches/all_barley.mp4",
to = "./submission/Movie_S2_barley.mp4",
overwrite = TRUE)
file.copy(from = "./figures/crop_niches/all_broomcorn_millet.mp4",
to = "./submission/Movie_S3_broomcorn_millet.mp4",
overwrite = TRUE)
file.copy(from = "./figures/crop_niches/all_foxtail_millet.mp4",
to = "./submission/Movie_S4_foxtail_millet.mp4",
overwrite = TRUE)
file.copy(from = "./figures/crop_niches/all_buckwheat.mp4",
to = "./submission/Movie_S5_buckwheat.mp4",
overwrite = TRUE)
file.copy(from = "./figures/crop_niches/all_rice.mp4",
to = "./submission/Movie_S6_rice.mp4",
overwrite = TRUE)

# Write the compendium
system(paste0("cp -r ../ ",tempdir(),"/Data_file_S3_research_compendium/"))

system(paste("tar -zcf submission/Data_file_S3_research_compendium.tar.gz",
"-C ",tempdir(),
"--exclude='vignettes/data'",
"--exclude='vignettes/figures'",
"--exclude='vignettes/submission'",
"--exclude='vignettes/GutakerEtAl2019_cache'",
"--exclude='vignettes/zenodo'",
"--exclude='.git'",
"Data_file_S3_research_compendium"))

```


## Create Zenodo archive {-}

```{r zenodo, cache = FALSE}
unlink("./zenodo",
recursive = TRUE, 
force = TRUE)

dir.create("./zenodo",
recursive = TRUE,
showWarnings = FALSE)

system("tar -zcf ./zenodo/gutaker2019-1.0.0-output.tar.gz submission figures data")
```


<!-- The following line inserts a page break when the output is MS Word. For page breaks in PDF, use \newpage on its own line.  -->
##### pagebreak

## References {-}
<!-- The following line ensures the references appear here for the MS Word or HTML output files, rather than right at the end of the document (this will not work for PDF files):  -->
<div id="refs"></div>

##### pagebreak

## Colophon {-}

This report was generated on `r Sys.time()` using the following computational environment and dependencies: 

```{r colophon, cache = FALSE}
# which R packages and versions?
devtools::session_info()
```

The current Git commit details are:

```{r git details, cache = FALSE}
# what commit is this file at? You may need to change the path value
# if your Rmd is not in analysis/paper/
git2r::repository("..")
```
